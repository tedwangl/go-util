version: '3.8'

services:
  # ==================== 场景 1：单库 ====================
  mysql-single:
    image: mysql:8.0
    container_name: gormx-single
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: testdb
    ports:
      - "3306:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  # ==================== 场景 2：主从 ====================
  mysql-master:
    image: mysql:8.0
    container_name: gormx-master
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: testdb
    ports:
      - "3307:3306"
    command: >
      --default-authentication-plugin=mysql_native_password
      --server-id=1
      --log-bin=mysql-bin
      --binlog-format=ROW
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  mysql-slave:
    image: mysql:8.0
    container_name: gormx-slave
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: testdb
    ports:
      - "3308:3306"
    command: >
      --default-authentication-plugin=mysql_native_password
      --server-id=2
      --relay-log=relay-bin
      --read-only=1
    depends_on:
      mysql-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  # ==================== 场景 3：混合分片 ====================
  mysql-default:
    image: mysql:8.0
    container_name: gormx-default
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: testdb
    ports:
      - "3309:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  mysql-default-slave:
    image: mysql:8.0
    container_name: gormx-default-slave
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: testdb
    ports:
      - "3310:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  mysql-shard1:
    image: mysql:8.0
    container_name: gormx-shard1
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: shard1
    ports:
      - "3311:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  mysql-shard1-slave:
    image: mysql:8.0
    container_name: gormx-shard1-slave
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: shard1
    ports:
      - "3312:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  mysql-shard2:
    image: mysql:8.0
    container_name: gormx-shard2
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: shard2
    ports:
      - "3313:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  mysql-shard2-slave:
    image: mysql:8.0
    container_name: gormx-shard2-slave
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: shard2
    ports:
      - "3314:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  # ==================== 场景 4：纯分片 ====================
  mysql-pure-shard0:
    image: mysql:8.0
    container_name: gormx-pure-shard0
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: shard0
    ports:
      - "3315:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  mysql-pure-shard0-slave:
    image: mysql:8.0
    container_name: gormx-pure-shard0-slave
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: shard0
    ports:
      - "3316:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  mysql-pure-shard1:
    image: mysql:8.0
    container_name: gormx-pure-shard1
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: shard1
    ports:
      - "3317:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

  mysql-pure-shard1-slave:
    image: mysql:8.0
    container_name: gormx-pure-shard1-slave
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: shard1
    ports:
      - "3318:3306"
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 5s
      timeout: 3s
      retries: 10

networks:
  default:
    name: gormx-network
